name: ðŸš€ Smart Powershell Module Release Pipeline - ManifestVersioning

# ðŸŽ¯ Triggers: Push to master branch (e.g., PR merge)
# ðŸ“‹ Required Repository Variables:
# - UBUNTU_VERSION: Ubuntu runner version (e.g., "ubuntu-22.04")
# ðŸ“‹ Required Repository Secrets:  
# - REPO_DISPATCH_TOKEN: Personal Access Token for cross-repo dispatch

on:
  push:
    branches: [master, main]

env:
  # ðŸŒ Global environment variables for consistency
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  MODULE_NAME: 'K.PSGallery.ManifestVersioning'
  TARGET_REPOSITORY: ${{ vars.TARGET_REPOSITORY || 'GrexyLoco/K.PSGallery' }}

jobs:
  validate:
    name: ðŸ” Security & ðŸ§ª Tests
    runs-on: ${{ vars.UBUNTU_VERSION }}
    outputs:
      test-success: ${{ steps.validation.outputs.test-success }}
      total-tests: ${{ steps.validation.outputs.total-tests }}
      passed-tests: ${{ steps.validation.outputs.passed-tests }}
      failed-tests: ${{ steps.validation.outputs.failed-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§ª Validate PowerShell Module 
        id: validation
        uses: GrexyLoco/K.Actions.PSModuleValidation@v1.0.1
        with:
          test-path: './Tests'
          output-path: './TestResults.xml'
          validate-all-codebase: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          module-name: ${{ env.MODULE_NAME }}

  release:
    name: ðŸš€ Smart Release
    needs: validate
    runs-on: ${{ vars.UBUNTU_VERSION }}
    outputs:
      new-version: ${{ steps.version.outputs.newVersion }}
      bump-type: ${{ steps.version.outputs.bumpType }}
      release-created: ${{ steps.version.outputs.bumpType != 'none' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextVersion@latest
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ›‘ Skip if no changes
        if: steps.version.outputs.bumpType == 'none'
        run: |
          echo "## ðŸ” No Release Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No version changes detected. Skipping release." >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **No changes detected** - workflow will exit gracefully" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ” No Release Required"
          echo "No version changes detected. Skipping release."
          echo "â„¹ï¸ Workflow will exit gracefully"

      - name: ðŸ“ Update PowerShell Module Version
        if: steps.version.outputs.bumpType != 'none'
        shell: pwsh
        run: |
          Write-Host "ðŸ”§ Updating PSD1 ModuleVersion..."
          
          # ðŸ“ Summary output
          "## ðŸ“ PowerShell Module Version Update" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          # ðŸ” Find PSD1 files in current directory
          $psd1Files = Get-ChildItem -Filter "*.psd1" -File
          
          if ($psd1Files.Count -eq 0) {
            Write-Host "âš ï¸ No PSD1 files found - skipping version update"
            "âš ï¸ **No PSD1 files found** - skipping version update" >> $env:GITHUB_STEP_SUMMARY
            exit 0
          }
          
          $newVersion = "${{ steps.version.outputs.newVersion }}"
          Write-Host "ðŸ“¦ New version: $newVersion"
          
          "**Target Version:** ``$newVersion``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### Updated Files:" >> $env:GITHUB_STEP_SUMMARY
          
          foreach ($psd1File in $psd1Files) {
            Write-Host "ðŸ“ Updating: $($psd1File.Name)"
            
            # ðŸ“– Read current content
            $content = Get-Content $psd1File.FullName -Raw
            
            # ðŸ”„ Replace ModuleVersion
            $updatedContent = $content -replace "ModuleVersion\s*=\s*'[^']*'", "ModuleVersion = '$newVersion'"
            
            # âœï¸ Write back
            Set-Content -Path $psd1File.FullName -Value $updatedContent -NoNewline
            
            Write-Host "âœ… Updated $($psd1File.Name) to version $newVersion"
            "- âœ… ``$($psd1File.Name)`` â†’ ``$newVersion``" >> $env:GITHUB_STEP_SUMMARY
          }

      - name: ðŸ’¾ Commit PSD1 version update 
        if: steps.version.outputs.bumpType != 'none'
        run: |
          git config user.name "${{ env.RELEASE_AUTHOR }}"
          git config user.email "${{ env.RELEASE_EMAIL }}"
          
          # ðŸ“ Summary header
          echo "## ðŸ’¾ Version Commit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ðŸ“‹ Check if there are changes
          if git diff --quiet; then
            echo "â„¹ï¸ No PSD1 changes to commit"
            echo "â„¹ï¸ **No PSD1 changes** to commit" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ Committing PSD1 version update..."
            git add "*.psd1"
            git commit -m "ðŸ”– Update module version to ${{ steps.version.outputs.newVersion }}

            Auto-updated by release workflow
            - Bump type: ${{ steps.version.outputs.bumpType }}
            - Triggered by: ${{ github.actor }}"
            
            echo "ðŸ“¤ Pushing version update..."
            git push origin ${{ github.ref_name }}
            echo "âœ… PSD1 version update committed and pushed"
            
            # ðŸ“ Summary output
            echo "âœ… **PSD1 version committed and pushed**" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ steps.version.outputs.newVersion }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Bump: \`${{ steps.version.outputs.bumpType }}\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”„ Re-fetch after PSD1 update
        if: steps.version.outputs.bumpType != 'none'
        run: |
          echo "ðŸ”„ Re-fetching repository state after PSD1 update..."
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          echo "âœ… Repository state synchronized"

      - name: ðŸ“¦ Create GitHub Release
        if: steps.version.outputs.bumpType != 'none'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ðŸ“ Summary header
          echo "## ðŸ“¦ GitHub Release Creation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ðŸŽ¨ Custom release notes template
          VERSION="${{ steps.version.outputs.newVersion }}"
          MAJOR=$(echo "$VERSION" | sed -E 's/^([0-9]+)\..*/\1/')
          MINOR=$(echo "$VERSION" | sed -E 's/^([0-9]+\.[0-9]+)\..*/\1/')
          
          echo "ðŸ” Debug: VERSION=$VERSION, MAJOR=$MAJOR, MINOR=$MINOR"
          
          # Create release notes
          RELEASE_DATE=$(date -u '+%B %d, %Y at %H:%M UTC')
          {
            echo "## ðŸŽ‰ Release v$VERSION"
            echo ""
            echo "> **${{ steps.version.outputs.bumpType }}** release â€¢ Released on $RELEASE_DATE"
            echo ""
            echo "### ðŸ“¦ Quick Access Links"
            echo "- ðŸ”— **[ðŸ“¦ PowerShell Gallery](https://www.powershellgallery.com/packages/K.PSGallery.ManifestVersioning/$VERSION)** - Install with \`Install-Module\`"
            echo "- ðŸ“ **[ðŸ”§ Source Code](https://github.com/${{ github.repository }})** - View the source"
            echo "- ðŸ·ï¸ **[ðŸŽ¯ This Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)** - Release details"
            echo ""
            echo "### ðŸš€ Installation & Usage"
            echo '```powershell'
            echo "# Install from PowerShell Gallery"
            echo "Install-Module -Name K.PSGallery.ManifestVersioning -RequiredVersion $VERSION"
            echo ""
            echo "# Update manifest version"
            echo "Update-ModuleManifestVersion -ManifestPath ./MyModule.psd1 -NewVersion '1.2.3'"
            echo '```'
            echo ""
            echo "### ðŸ”„ PowerShell Gallery"
            echo "This module will be automatically published to [PowerShell Gallery](https://www.powershellgallery.com/packages/K.PSGallery.ManifestVersioning) within minutes."
            echo ""
            echo "---"
            echo "*Generated by [K.Actions.NextVersion](https://github.com/GrexyLoco/K.Actions.NextVersion)*"
          } > release_notes.md
          
          RELEASE_TAG="v${{ steps.version.outputs.newVersion }}"
          
          # Create release as DRAFT
          IS_PRERELEASE="false"
          if [[ "$VERSION" =~ (alpha|beta|rc|preview|pre) ]]; then
            IS_PRERELEASE="true"
            echo "ðŸ§ª Creating prerelease as DRAFT..."
            gh release create "$RELEASE_TAG" \
              --title "ðŸ§ª Prerelease $RELEASE_TAG" \
              --notes-file release_notes.md \
              --generate-notes \
              --prerelease \
              --draft || echo "âš ï¸ Release creation warning (may already exist)"
          else
            echo "ðŸš€ Creating stable release as DRAFT..."
            gh release create "$RELEASE_TAG" \
              --title "ðŸš€ Release $RELEASE_TAG" \
              --notes-file release_notes.md \
              --generate-notes \
              --draft || echo "âš ï¸ Release creation warning (may already exist)"
          fi

      - name: ðŸ·ï¸ Create smart tags  
        if: steps.version.outputs.bumpType != 'none'
        run: |
          git config user.name "${{ env.RELEASE_AUTHOR }}"
          git config user.email "${{ env.RELEASE_EMAIL }}"
          
          echo "## ðŸ·ï¸ Smart Tag Management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          NEW_TAG="v${{ steps.version.outputs.newVersion }}"
          MAJOR=$(echo "$NEW_TAG" | sed -E 's/^v([0-9]+)\..*/\1/')
          MINOR=$(echo "$NEW_TAG" | sed -E 's/^v[0-9]+\.([0-9]+)\..*/\1/')
          VERSION="${{ steps.version.outputs.newVersion }}"
          
          # Only create smart tags for stable releases
          if [[ ! "$VERSION" =~ (alpha|beta|rc|preview|pre) ]]; then
            MINOR_TAG="v$MAJOR.$MINOR"
            MAJOR_TAG="v$MAJOR"
            
            echo "### ðŸŽ¯ Tags Updated:" >> $GITHUB_STEP_SUMMARY
            
            case "${{ steps.version.outputs.bumpType }}" in
              "patch")
                git push --delete origin "$MINOR_TAG" 2>/dev/null || true
                git push --delete origin "$MAJOR_TAG" 2>/dev/null || true
                git tag -d "$MINOR_TAG" 2>/dev/null || true
                git tag -d "$MAJOR_TAG" 2>/dev/null || true
                git tag "$MINOR_TAG" "$NEW_TAG" && git push origin "$MINOR_TAG"
                git tag "$MAJOR_TAG" "$NEW_TAG" && git push origin "$MAJOR_TAG"
                echo "- âœ… Updated: \`$MINOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                echo "- âœ… Updated: \`$MAJOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                ;;
              "minor") 
                git tag "$MINOR_TAG" "$NEW_TAG" && git push origin "$MINOR_TAG"
                git tag -f "$MAJOR_TAG" "$NEW_TAG" && git push -f origin "$MAJOR_TAG"
                echo "- ðŸ†• Created: \`$MINOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                echo "- âœ… Updated: \`$MAJOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                ;;
              "major")
                git tag "$MINOR_TAG" "$NEW_TAG" && git push origin "$MINOR_TAG"  
                git tag "$MAJOR_TAG" "$NEW_TAG" && git push origin "$MAJOR_TAG"
                echo "- ðŸ†• Created: \`$MINOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                echo "- ðŸ†• Created: \`$MAJOR_TAG\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            
            git push --delete origin "latest" 2>/dev/null || true
            git tag -d "latest" 2>/dev/null || true
            git tag "latest" "$NEW_TAG" && git push origin "latest"
            echo "- âœ… Updated: \`latest\` â†’ \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Skipped smart tags** (prerelease version)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš€ Publish Release (Final Step)
        if: steps.version.outputs.bumpType != 'none'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸš€ Release Publication Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          RELEASE_TAG="v${{ steps.version.outputs.newVersion }}"
          VERSION="${{ steps.version.outputs.newVersion }}"
          
          if [[ "$VERSION" =~ (alpha|beta|rc|preview|pre) ]]; then
            echo "ðŸ§ª Publishing prerelease..."
            gh release edit "$RELEASE_TAG" --draft=false || echo "âš ï¸ Publication warning"
            echo "ðŸ§ª **Prerelease published:** \`$RELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ Publishing stable release with latest flag..."
            gh release edit "$RELEASE_TAG" --draft=false --latest || echo "âš ï¸ Publication warning"
            echo "ðŸš€ **Stable release published and marked latest:** \`$RELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: ðŸ“£ Deploy Notification
    needs: [validate, release]
    if: needs.release.outputs.release-created == 'true' && needs.validate.outputs.test-success == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION }}
    steps:
      - name: ðŸ“£ Notify deployment pipeline
        run: |
          echo "## ðŸ“£ Deployment Notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ðŸŽ¯ K.PSGallery deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`v${{ needs.release.outputs.new-version }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Execute repository dispatch
        uses: peter-evans/repository-dispatch@v3
        with:
            token: ${{ secrets.REPO_DISPATCH_TOKEN }}
            repository: grexyloco/K.PSGallery
            event-type: publish_module
            client-payload: |
              {
                "repo": "${{ github.repository }}",
                "tag": "v${{ needs.release.outputs.new-version }}",
                "bump_type": "${{ needs.release.outputs.bump-type }}",
                "triggered_by": "${{ github.actor }}",
                "source_url": "https://github.com/${{ github.repository }}",
                "gallery_url": "https://www.powershellgallery.com/packages/K.PSGallery.ManifestVersioning/${{ needs.release.outputs.new-version }}"
              }
